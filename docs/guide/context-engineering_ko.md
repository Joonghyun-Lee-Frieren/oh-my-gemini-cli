# OmG 컨텍스트 엔지니어링 가이드

> "Cache rules everything around me."
>
> 장기 실행 에이전트 워크플로우에서는 컨텍스트 품질과 캐시 안정성이 속도, 비용, 정확도를 결정합니다.

## 컨텍스트 엔지니어링이란

컨텍스트 엔지니어링은 모델이 올바른 정보를 올바른 순서로 보도록 프롬프트/컨텍스트 구조를 설계하는 작업입니다.

OmG에서 이 개념은 단순한 "좋은 프롬프트 작성"이 아니라, 다음을 포함한 운영 모델입니다.

- 안정적인 prefix 유지
- 동적 데이터의 안전한 추가
- 스테이지 간 핸드오프 요약
- 검증 근거를 보존하면서 컨텍스트 비대화를 억제

## 왜 중요한가

컨텍스트 엔지니어링이 없으면 장기 세션에서 다음 문제가 빠르게 발생합니다.

- prefix가 조금만 바뀌어도 캐시 적중률 하락
- 대규모 prefix 재계산으로 지연 증가
- 동일 토큰 반복 처리로 비용 상승
- 범위/수용 기준이 흐려져 품질 드리프트 발생

## OmG 컨텍스트 레이어

| 레이어 | 주요 내용 | 변경 빈도 | 캐시 기대치 |
| --- | --- | --- | --- |
| 1. 시스템/런타임 | 플랫폼 제약, 기본 동작 | 매우 낮음 | 매우 높음 |
| 2. 프로젝트 표준 | 저장소 규칙, 아키텍처 원칙 | 낮음 | 높음 |
| 3. 공유 프로젝트 컨텍스트 | `GEMINI.md`, 공통 워크플로우 규칙 | 낮음~중간 | 높음 |
| 4. 스테이지 컨텍스트 | plan/prd/exec/verify 진행 상태 | 중간 | 중간 |
| 5. 턴 동적 데이터 | 최신 요청, 리마인더, 신규 근거 | 높음 | 낮음(append 중심) |

## 스테이지 파이프라인과 컨텍스트 규율

OmG는 다음 스테이지를 사용합니다.

1. `team-plan`
2. `team-prd`
3. `team-exec`
4. `team-verify`
5. `team-fix`

스테이지별 컨텍스트 목표:

| 스테이지 | 컨텍스트 초점 | 유지할 것 | 피할 것 |
| --- | --- | --- | --- |
| `team-plan` | 작업 분해, 의존성 그래프 | 범위 경계 | 구현 상세 노이즈 |
| `team-prd` | 수용 기준, 비범위 정의 | 측정 가능한 완료 기준 | 모호한 완료 표현 |
| `team-exec` | 승인된 범위 구현 | 최소 diff + 변경 이유 | 과도한 재설계 |
| `team-verify` | 기준별 검증 근거 | pass/fail 매트릭스 | 근거 없는 의견 |
| `team-fix` | 검증 실패 항목 수정 | 이슈→원인→패치 | 무관한 리팩터링 |

## 고효율 패턴 6가지

### 1) Prefix 안정성

고정 지시문은 앞에, 변경 데이터는 뒤에 둡니다.

Bad:

```text
[동적 timestamp][시스템 지시문][프로젝트 컨텍스트]
```

Good:

```text
[시스템 지시문][프로젝트 컨텍스트][스테이지 컨텍스트][동적 리마인더]
```

### 2) Tool 불변성

활성 세션 중에는 노출된 툴셋을 자주 바꾸지 않습니다.  
가능하면 툴 정의는 고정하고, 사용 방식만 바꿉니다.

### 3) 서브 에이전트 기반 모델 분리

캐시 재사용이 중요한 구간에서는 한 체인 내부의 잦은 모델 전환을 피합니다.  
`planner`, `executor`, `reviewer` 같은 역할별 서브 에이전트로 분리해 각자 안정적인 컨텍스트 스트림을 유지합니다.

### 4) Cache-Safe Compaction

컨텍스트가 길어지면 다음 순서로 압축합니다.

1. 안정적인 prefix 보존
2. 변동 이력만 구조화 요약
3. 요약 + 최신 근거 기반으로 진행

### 5) System Reminder 주입

시간/임시 상태 같은 자주 바뀌는 값을 시스템 프롬프트에 직접 수정하지 않습니다.  
대신 후행 리마인더 블록에 주입합니다.

### 6) 모드 인지 운영

OmG 모드는 컨텍스트 압력을 다르게 만듭니다.

| 모드 | 컨텍스트 동작 |
| --- | --- |
| `balanced` | 기본 균형, 중간 수준 상세도 |
| `speed` | 짧은 요약, 빠른 스테이지 전환 |
| `deep` | 더 깊은 근거와 엄격한 검증 |
| `autopilot` | 루프형 스냅샷/체크포인트 중심 |
| `ralph` | 완료 전 게이트 근거 강제 |
| `ultrawork` | 병렬 샤드 요약 중심 |

## 런타임 상태 파일

장기 워크플로우에서는 다음 상태 파일을 유지합니다.

- `.omg/state/mode.json`
- `.omg/state/workflow.md`
- `.omg/state/checkpoint.md`

이 파일들은 전체 대화를 재생하지 않고도 재시작을 가능하게 합니다.

## 모니터링 명령

- `/omg:status`: 스테이지/모드/진행 상태 확인
- `/omg:cache`: 캐시 안정성 리스크 점검
- `/omg:optimize`: 컨텍스트 비대화/변동성 최적화
- `/omg:checkpoint`: 재개용 요약 상태 저장

## 캐시 미스 트리아지

| 증상 | 가능 원인 | 조치 |
| --- | --- | --- |
| 지연 시간 급증 | prefix 앞부분 변형 | 고정 prefix 순서 복원 |
| 세션 맥락 재시작 반복 | 동적 데이터가 고정 블록에 혼입 | 동적 값을 리마인더로 이동 |
| 검증 품질 저하 | 수용 기준이 턴 간 유지되지 않음 | 기준 매트릭스를 항상 명시 |
| 루프 비용 과다 | 체크포인트 없는 누적 진행 | checkpoint + cache-safe compaction 적용 |

## 실전 체크리스트

주요 턴 시작 전 확인:

- 현재 스테이지(`plan/prd/exec/verify/fix`) 확인
- 활성 모드 확인
- 수용 기준 가시화 유지
- 고정 블록 재작성 대신 신규 근거만 append
- 종료 시 status와 next action 명시

## 관련 문서

- [설치 가이드](./installation.md)
- [영문 컨텍스트 가이드](./context-engineering.md)
- [변경 이력](../history.md)
